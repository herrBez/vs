\exercise{Esercizio 8}
{
  Provare o fornire un controesempio per la seguente equivalenza semantica: \\
  $$
   \wbS{b}{S} \eqSOS{} \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
  $$
}
{
È necessario dimostrare che
$$
\forall s,s'.
  \Big(\confSs{\wbS{b}{S}}{s} \Rar{*} s'
  \iff
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} \Rar{*} s' \Big)
$$
}
\begin{proof}
Vengano fissati due stati $s, s' \in \states$. La prova procede dunque andando
a verificare entrambi i versi della doppia implicazione.
$$
\boxed{\implies}
$$
Si assuma che $\confSs{\wbS{b}{S}}{s} \Rar{*} s'$. Vengono studiati i due casi
che si possono verificare a seconda della valutazione della guardia booleana $b$
nello stato di memoria $s$:
\begin{itemize}
  \item $\boxed{\B{b} = \semfalse}$
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{S}}{s} \Rar{ } & \whileSOS \\
  \confSs{\ifABC{b}{(S; \wbS{b}{S})}{\skipForFriends}}{s} \Rar{ }& \ifffSOS \\
  \confSs{\skipForFriends}{s} \Rar{} & \skipSOS\\
  s
  \end{array}
  $$
  Quindi si ottiene che $s \equiv{} s'$.
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} & \whileSOS \\
  \confSs{\ifABC{b}
            {((S;\ \ifABC{b}{S}{\skipForFriends});
              \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})})}
            {\skipForFriends}
         }{s} \Rar{ }& \ifffSOS \\
  \confSs{\skipForFriends}{s} \Rar{} & \skipSOS\\
  s
  \end{array}
  $$
  Di conseguenza si ottiene anche che quando $\B{b} = \semfalse$ i due
  statement sono equivalenti.

% => case: true
  \item $\boxed{\B{b} = \semtrue}$
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{S}}{s} \Rar{ }  & \whileSOS \\
  \confSs{\ifABC{b}{(S;\wbS{b}{S})}{\skipForFriends}}{s} \Rar{ } & \ifttSOS\\
  \confSs{S; \wbS{b}{S}}{s} \Rar{*} & (\text{Assunzione + Determinismo})\\
  s'
  \end{array}
  $$
  Mentre per lo statement a destra dell'equivalenza da provare si ha:
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} & \whileSOS \\
  \confSs{\ifABC{b}
            {((S;\ \ifABC{b}{S}{\skipForFriends});
              \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})})}
            {\skipForFriends}
         }{s} \Rar{ }& \ifttSOS \\
  \confSs{  (S;\ \ifABC{b}{S}{\skipForFriends});
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s}
  \end{array}
  $$
  Per il lemma di decomposizione applicato a
  \begin{equation}
  \confSs{S; \wbS{b}{S}}{s} \Rar{*} s'
    \label{eq:hw8:imp}
  \end{equation}
  si ottiene che $\exists s'' \in \states$ tale che:
  \begin{enumerate}[label=(\alph*)]
    \item $\confSs{S}{s} \Rar{*} s''$
    \label{hw8:item1}
    \item $\confSs{\wbS{b}{S}}{s''} \Rar{*} s'$
    \label{hw8:item2}
  \end{enumerate}
  Da \ref{hw8:item2} si ha, per l'esercizio 2, che:
  \begin{enumerate}[label=(\Roman*)]
    \item $\B{b}' = \semfalse$
    \label{hw8:Bbs':ff}
  \end{enumerate}
  Per il lemma di composizione applicato a \ref{hw8:item1} si ricava che:
  $$
  \confSs{(S;\ \ifABC{b}{S}{\skipForFriends})}{s}
    \Rar{*}
  \confSs{\ifABC{b}{S}{\skipForFriends}}{s''}
  $$
  Andando ulteriormente a derivare entrambi il primo termine
  $\confSs{\wbS{b}{S}}{s''}$ a partire dallo stato $s''$ raggiunto dopo una
  esecuzione dello statement $S$, si ottiene:
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{S}}{s''} \Rar{ }  & \whileSOS \\
  \confSs{\ifABC{b}{(S;\wbS{b}{S})}{\skipForFriends}}{s''} \Rar{*} & (\text{Assunzione + Determinismo})\\
  s'
  \end{array}
  $$
  Se la guardia $b$ verrà valutata a \semfalse, è banalmente dimostrabile che
  entrambi i termini terminano in uno stato $s' \equiv{} s''$.
  Altrimenti, se $\B{b}' = \semtrue$, i termini verranno derivati
  rispettivamente nel seguente modo applicando in ambo i casi la regola
  $\ifttSOS$\footnote{per il secondo termine, in realtà viene applicata anche
  $\compoSOS$}:
  \begin{enumerate}
    \item \confSs{S;\wbS{b}{S}}{s''} (per la parte sinistra dell'equivalenza)
    \label{hw8:item3}
    \item \confSs{S;\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s''}
      (per la parte destra dell'equivalenza)
  \end{enumerate}
  Si può applicare il lemma di decomposizione al termine \ref{hw8:item3},
  ottenendo che $\exists{s'''} \in \states$ tale che:
  \begin{enumerate}[label=(\alph*)]
    \item $\confSs{S}{s''} \Rar{*} s'''$
    \label{hw8:item4}
    \item $\confSs{\wbS{b}{S}}{s'''} \Rar{*} s'$ (per l'ipotesi iniziale)
    \label{hw8:item5}
  \end{enumerate}
  Applicando il lemma di composizione a \ref{hw8:item4} si ottiene
  $$
  \confSs{(S;\ \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s''}
    \Rar{*}
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s'''}
  $$
  È possibile notare che si è arrivati ad un punto nel quale si vuole provare
  l'asserzione iniziale su una derivazione di lunghezza strettamente inferiore,
  nello specifico partendo da uno stato $s'''$.

  Dunque tale verso della doppia implicazione è dimostrato per induzione sulla
  lunghezza della derivazione:
  \begin{itemize}
    \item il caso base ($\B{b} = \semfalse$ e derivazioni lunghe 3 passi di
      riduzione) è stato verificato;
    \item il passo induttivo (ottenibile ponendo $\B{b} = \semtrue$) porta a
      dover dimostrare la stessa proprietà eseguendo lo statement iniziale a
      partire da $s'''$, stato più avanzato nella derivazione rispetto a $s$.

      Poichè la derivazione che da $s'''$ porta a $s'$ è strettamente più
      corta di quella che porta da $s$ a $s'$\footnote{si è volutamente deciso
      di adottare un livello di informalità per esprimere in modo più
      conciso che si parte da una configurazione in un certo stato per
      arrivare ad un'altra configurazione in un secondo stato}, il passo
      induttivo è valido proprio per induzione sulla lunghezza della
      derivazione.
  \end{itemize}
\end{itemize}

%%%%%%%%
%% SECOND PART
%%%%%%%%

$$
\boxed{\impliedby}
$$
Si assuma che
$\confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} \Rar{*} s'$. Vengono
studiati i due casi che si possono verificare a seconda della valutazione
della guardia booleana $b$ nello stato di memoria $s$:

\begin{itemize}
  \item $\boxed{\B{b} = \semfalse}$ questo caso è analogo a quanto visto per
    $\boxed{\implies}$.
  \item $\boxed{\B{b} = \semtrue}$
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} & \whileSOS \\
  \confSs{\ifABC{b}
            {((S;\ \ifABC{b}{S}{\skipForFriends});
              \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})})}
            {\skipForFriends}
         }{s} \Rar{ }& \ifttSOS \\
  \confSs{  (S;\ \ifABC{b}{S}{\skipForFriends});
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s} \Rar{ }\\
  \Rar{ } (\text{Assunzione + Determinismo})\\
  s'
  \end{array}
  $$
  Per il lemma di decomposizione applicato a
  \begin{equation}
  \confSs{  (S;\ \ifABC{b}{S}{\skipForFriends});
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s}
    \Rar{*} s'
  \label{eq:hw8:isimpl}
  \end{equation}
  si ottiene che $\exists s'' \in \states$ tale che:
  \begin{enumerate}[label=(\alph*)]
    \item $\confSs{S;\ \ifABC{b}{S}{\skipForFriends}}{s} \Rar{*} s''$
    \label{hw8:item6}
    \item $\confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s''}
      \Rar{*} s'$
    \label{hw8:item7}
  \end{enumerate}
  Applicando un'ulteriore volta il lemma di decomposizione, da \ref{hw8:item6}
  si ottiene che $\exists{s'''}\in\states$ tale che:
  \begin{enumerate}[label=(\alph*)]
    \nextitem{c}
    \item $\confSs{S}{s} \Rar{*} s'''$
    \label{hw8:item8}
    \item $\confSs{\ifABC{b}{S}{\skipForFriends}}{s'''} \Rar{*} s''$
    \label{hw8:item9}
  \end{enumerate}
  Chiaramente, per il lemma di composizione applicato ad \ref{hw8:item8} è
  valida la seguente implicazione:
  \begin{equation}
  \confSs{S}{s} \Rar{*} s'''
    \implies
  \confSs{S; \wbS{b}{S}}{s} \Rar{*} \confSs{\wbS{b}{S}}{s'''}
  \label{eq:hw8:item10}
  \end{equation}
  Ottenuto questo risultato, si passa a valutare il lato sinistro
  dell'equivalenza:
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{S}}{s} \Rar{ }  & \whileSOS \\
  \confSs{\ifABC{b}{(S;\wbS{b}{S})}{\skipForFriends}}{s} \Rar{ } & \ifttSOS\\
  \confSs{S; \wbS{b}{S}}{s} \Rar{*} & (\text{\ref{eq:hw8:item10}})\\
  \confSs{\wbS{b}{S}}{s'''}
  \end{array}
  $$
  In $s'''$ verrà valutata la guardia $b$ in entrambi i lati dell'equivalenza.
  Come visto in precedenza, nel caso in cui $\B{b}''' = \semfalse$,
  l'equivalenza è facilmente verificabile.

  Altrimenti (ovvero se $\B{b}''' = \semtrue$) le due configurazioni evolvono
  come segue (verrà mostrato prima il lato destro):
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} & \whileSOS \\
  \confSs{\ifABC{b}
            {((S;\ \ifABC{b}{S}{\skipForFriends});
              \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})})}
            {\skipForFriends}
         }{s} \Rar{ }& \ifttSOS \\
  \confSs{  (S;\ \ifABC{b}{S}{\skipForFriends});
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s} \Rar{ } \\
  \Rar{ } (\text{$\compoSOS$})\\
  \confSs{  \ifABC{b}{S}{\skipForFriends};
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s'''} \Rar{ } & \ifttSOS \\
  \confSs{  S;
            \wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}
         }{s'''} \Rar{ } \\
  \Rar{ } (\text{Assunzione + Determinismo})\\
  s'
  \end{array}
  $$
  Per il lemma di decomposizione, si ha che $\exists{t}\in\states$:
  \begin{enumerate}[label=(\alph*)]
    \nextitem{e}
    \item $\confSs{S}{s} \Rar{*} t$
    \label{hw8:item11}
    \item $\confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{t} \Rar{*} s'$
    \label{hw8:item12}
  \end{enumerate}
  Chiaramente, per il lemma di composizione applicato a \ref{hw8:item11} si ha:
  \begin{equation}
  \confSs{S; \wbS{b}{S}}{s'''} \Rar{*} \confSs{\wbS{b}{S}}{t}
  \label{eq:hw8:item13}
  \end{equation}
  Per quanto riguarda il lato sinistro dell'equivalenza, si ottiene:
  $$
  \begin{array}{lr}
  \confSs{\wbS{b}{S}}{s} \Rar{ }  & \whileSOS \\
  \confSs{\ifABC{b}{(S;\wbS{b}{S})}{\skipForFriends}}{s} \Rar{ } & \ifttSOS\\
  \confSs{S; \wbS{b}{S}}{s} \Rar{*} & (\text{\ref{eq:hw8:item10}})\\
  \confSs{\wbS{b}{S}}{s'''}  & \whileSOS \\
  \confSs{\ifABC{b}{(S;\wbS{b}{S})}{\skipForFriends}}{s'''}
      \Rar{ } & \ifttSOS\\
  \confSs{S;\wbS{b}{S}}{s'''} \Rar{*} & (\text{\ref{eq:hw8:item13}}) \\
  \confSs{\wbS{b}{S}}{t}
  \end{array}
  $$
  A questo punto, è possibile concludere la dimostrazione; infatti, partendo
  da:
  $$
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{s} \Rar{*} s'
  \implies
  \confSs{\wbS{b}{S}}{s} \Rar{*} s'
  $$
  Si vuole dimostrare che
  $$
  \confSs{\wbS{b}{(S;\ \ifABC{b}{S}{\skipForFriends})}}{t} \Rar{*} s'
  \implies
  \confSs{\wbS{b}{S}}{t} \Rar{*} s'
  $$
  Ma questo vale per induzione sulla lunghezza della derivazione poichè:
  \begin{itemize}
    \item il caso base ($\B{b} = \semfalse$) è stato verificato;
    \item il passo induttivo (ottenibile ponendo $\B{b} = \semtrue$) porta a
      dover dimostrare la stessa proprietà eseguendo lo statement iniziale a
      partire da $t$, stato più avanzato nella derivazione rispetto a $s$.

      Poichè la derivazione che da $t$ porta a $s'$ è strettamente più corta di
      quella che porta da $s$ a $s'$, il passo induttivo è valido proprio per
      induzione sulla lunghezza della derivazione.
  \end{itemize}
\end{itemize}

\end{proof}
